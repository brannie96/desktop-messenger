<!DOCTYPE html>
<html>
<head>
    <title>Loading ...</title>
    <script src='assets/progress.js'></script>
    <link rel='stylesheet' href='assets/progress.css'/>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            cursor: wait;
        }

        .main {
            background: url("assets/stickers.jpg") center bottom no-repeat;
            text-align: center;
        }

        table {
            -webkit-box-shadow: 0 0 10px 2px rgba(0, 0, 0, 0.45);
            margin: 0;
            width: 100%;
            height: 100%;
        }

        .footer {
            background: #323940;
            color: #ffffff;
            padding: 0 20px;
            font: 11px tahoma;
            height: 50px;
            text-align: center;
        }

        #version {
            position: absolute;
            left: 20px;
            top: 20px;
            font: 11px tahoma;
            color: #999;
        }
    </style>
</head>
<body>
<div id="version"></div>
<table border="0" cellpadding="0" cellspacing="0" bgcolor="white">
    <tr>
        <td class="main"><img src="assets/logo.jpg" width="149" height="151"></td>
    </tr>
    <tr>
        <td class="footer">© Facebook 2015. The Apple, Google Play, and Windows logos are trademarks of their respective
            owners.<br>
            Desktop Messenger is developed by Netlabs (c) 2015.
        </td>
    </tr>
</table>
<script>
    NProgress.start();
</script>
<script type="text/javascript">
    var gui = require('nw.gui'), new_win, win, inject_css;
    win = gui.Window.get();

    document.getElementById("version").innerHTML = "version: " + gui.App.manifest.version + " (build: " + gui.App.manifest.build + ")";
    __curDir = process.cwd();
    var fs = require("fs");
    var path = require('path');
    var nwDir = path.dirname(process.execPath);
    new_win = gui.Window.open('https://www.messenger.com/t/', {
        "icon": "assets/icon.png",
        "position": "center",
        "min_width": 400,
        "min_height": 200,
        "toolbar": false,
        "show": false
    });
    NProgress.set(0.3);
    global.screens = {};
    global.screens["splash"] = win;
    global.screens["main"] = new_win;

    //    global.mainWindow = new_win;
    NProgress.set(0.3);
    new_win.on('loaded', function () {
        if (new_win.window.document.getElementById("injected_js")) {
            global.screens.main.window.ga('send', 'pageview', new_win.window.document.location.pathname);
        } else {
            NProgress.set(0.6);
            var js_file, css_file;
            fs.exists(nwDir + '/theme.js', function (exists) {
                // check if there is js file in the current install dir or to use default;
                js_file = exists ? nwDir + '/theme.js' : __curDir + '/theme.js';
                fs.exists(nwDir + '/theme.css', function (exists) {
                    // check if there is js file in the current install dir or to use default;
                    css_file = exists ? nwDir + '/theme.css' : __curDir + '/theme.css';
                    fs.readFile(css_file, "utf8", function (error, data) {
                        add_file("css", data, new_win.window.document);
                        NProgress.set(0.8);
                        fs.readFile(js_file, "utf8", function (error, data) {
                            NProgress.set(1);
                            add_file("js", data, new_win.window.document);
                            setTimeout(function () {
                                win.hide();
                                new_win.maximize();
                                new_win.show();
                                new_win.focus();
                                global.screens.main.window.ga('send', 'pageview', new_win.window.document.location.pathname);
                            },300);
                        });
                    });
                });
            });
        }
    });
    new_win.on('close', function () {
        this.close(true);
        gui.App.quit();
    });
    win.on('close', function () {
        this.close(true);
        gui.App.quit();
    });

    function add_file(type, data, doc) {
        var head = doc.getElementsByTagName('head')[0];
        var s;
        if (type == "css") {
            s = doc.createElement('style');
            s.setAttribute('type', 'text/css');
            s.setAttribute('id', 'injected_' + type);
            s.appendChild(document.createTextNode(data));
        }
        if (type == "js") {
            s = doc.createElement('script');
            s.setAttribute('type', 'text/javascript');
            s.setAttribute('id', 'injected_' + type);
            s.appendChild(document.createTextNode(data));
        }
        head.appendChild(s);
    }

</script>
</body>
</html>